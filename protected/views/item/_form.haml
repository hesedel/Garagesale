.form

	:php
		$form=$this->beginWidget('CActiveForm', array(
			'id'=>'item-form',
			'enableAjaxValidation'=>true,
			'htmlOptions'=>array('enctype'=>'multipart/form-data'),
		));

	//=$form->errorSummary($model)

	%table.form(summary="Post a New Item")
		%caption.hide Item

		%tfoot

			%tr
				%td \\&#160;
				%td =CHtml::submitButton($model->isNewRecord ? 'Post' : 'Save')

		%tbody

			%tr
				%th =$form->labelEx($model,'title')
				%td
					.input-text
						=$form->textField($model,'title',array('size'=>60,'maxlength'=>64))
						%span.placeholder What are you selling?
					=$form->error($model,'title')

			%tr
				%th =$form->labelEx($model,'price')
				%td
					.price.input-text
						%span.prepend
							PHP
						=$form->textField($model,'price')
						%span.placeholder How much does it cost?
					= $form->error($model,'price')

			%tr
				%th Condition
				%td
					%fieldset
						%legend Condition	
						:php
							echo $form->radioButtonList($model,'condition_id',array(''=>'N/A','0'=>'Brand New','1'=>'Used'),array('separator'=>' &#160; '));
							echo $form->error($model,'condition_id');

			%tr
				%th =$form->labelEx($model,'description')
				%td
					.textarea
						=$form->textArea($model,'description',array('rows'=>6, 'cols'=>50))
						%span.placeholder Describe what you are selling.<br/>Longer descriptions sell more.
					=$form->error($model,'description');

			%tr
				%th =$form->labelEx($model,'images')
				%td
					:php
						$uploads = unserialize(base64_decode($model->uploads));
						if(!$model->isNewRecord && !$uploads) {
							foreach(glob(Yii::getPathOfAlias('webroot').'/images/uploads/items/'.$model->id.'/*.jpg') as $image) {
								$file = pathinfo($image);
								$uploads[] = array('name'=>$file['filename'], 'tempName'=>'', 'new'=>false);
							}
							//sort($uploads);
						}
						if(strlen($form->error($model, 'images')) <= 74) {
							$images = CUploadedFile::getInstances($model, 'images');
							foreach($images as $image) {
								$name = md5($image->name.time()).'.jpg';
								$image->saveAs(Yii::getPathOfAlias('webroot').'/images/uploads/temp/'.$name);
								$uploads[] = array('name'=>$image->name, 'tempName'=>$name, 'new'=>true);
							}
						}
						if($uploads) :
					.images
						:php
							foreach($uploads as $upload) {
								if($upload['new'])
									echo '<div class="image new" title="'.$upload['name'].'" style="background-image: url(/images/slir/w40-h36-c40:36/images/uploads/temp/'.$upload['tempName'].')"><a title="remove '.$upload['name'].'" href="#"><span></span></a></div>';
								else
									echo '<div class="image" title="'.$upload['name'].'" style="background-image: url(/images/slir/w40-h38-c40:36/images/uploads/items/'.$model->id.'/'.$upload['name'].'.jpg)"><a title="remove '.$upload['name'].'" href="#"><span></span></a></div>';
							}
							echo $form->hiddenField($model,'uploads',array('value'=>base64_encode(serialize($uploads))));
					:php
						endif;
						$this->widget('CMultiFileUpload',array(
							'model'=>$model,
							'attribute'=>'images',
							'accept'=>'gif|jpg|jpeg|png',
							'max'=>5,
							'remove'=>'remove',
						));
					=$form->error($model,'images')
					.no-js
						JavaScript required

	:php
		$this->endWidget()

:php
	Yii::app()->clientScript->registerScript(
		'_form',
		"
		var uploadIndex_from = 0;
		$('div.images', '#item_create, #item_update').sortable( {
			revert: true,
			opacity: .75,
			start: function(event) {
				uploadIndex_from = $(event.target).index();
			},
			update: function(event) {
				var uploadIndex_to = $(event.target).index();
				var input = unserialize(base64_decode($('#Item_uploads').val()));
				var output = [];
				output[uploadIndex_to] = input[uploadIndex_from];
				for(var i in input) {
					if((i < uploadIndex_from && i < uploadIndex_to) || (i > uploadIndex_from && i > uploadIndex_to))
						output[i] = input[i];
					else if(i != uploadIndex_to) {
						if(uploadIndex_from < uploadIndex_to)
							output[i] = input[parseInt(i) + 1];
						else
							output[i] = input[i - 1];
					}
				}
				$('#Item_uploads').val(base64_encode(serialize(output)));
			}
		});
		$('a', '#item_create div.images div.image, #item_update div.images div.image').click(function() {
			var \$this = $(this);
			var input = unserialize(base64_decode($('#Item_uploads').val()));
			var output = [];
			for(var i in input) {
				if(i < \$this.parent().index())
					output[i] = input[i];
				else if(i > \$this.parent().index())
					output[i - 1] = input[i];
			}
			$('#Item_uploads').val(base64_encode(serialize(output)));
			var image = \$this.parent().attr('style');
			\$this.parent().remove();
			$.post(
				'/ad/ajaxRemoveImage/',
				{
					image: image.substring(image.indexOf('=') + 2, image.indexOf('&'))
				},
				function(data) {
					if($('div.images', '#item_create, #item_update').children('div.image').size() == 0)
						$('div.images', '#item_create, #item_update').remove();
				}
			);
			return false;
		});
		",
		CClientScript::POS_READY
	);